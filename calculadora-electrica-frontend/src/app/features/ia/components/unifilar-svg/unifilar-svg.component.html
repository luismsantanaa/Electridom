<div class="unifilar-container">
  <div class="unifilar-header">
    <h2>Diagrama Unifilar</h2>
    <div class="header-actions">
      <div class="zoom-controls">
        <button class="btn btn-sm btn-outline-secondary" (click)="zoomOut()" title="Alejar">
          <i class="fas fa-search-minus"></i>
        </button>
        <span class="zoom-level">{{ (zoom() * 100).toFixed(0) }}%</span>
        <button class="btn btn-sm btn-outline-secondary" (click)="zoomIn()" title="Acercar">
          <i class="fas fa-search-plus"></i>
        </button>
        <button class="btn btn-sm btn-outline-secondary" (click)="resetZoom()" title="Restablecer">
          <i class="fas fa-expand-arrows-alt"></i>
        </button>
      </div>
      <button class="btn btn-primary" (click)="generateUnifilarDiagram()" [disabled]="isLoading()">
        <i class="fas fa-refresh"></i> Regenerar
      </button>
      <button class="btn btn-success" (click)="exportAsSVG()">
        <i class="fas fa-file-code"></i> Exportar SVG
      </button>
      <button class="btn btn-info" (click)="exportAsPNG()">
        <i class="fas fa-file-image"></i> Exportar PNG
      </button>
    </div>
  </div>

  @if (isLoading()) {
    <div class="loading-container">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Generando diagrama...</span>
      </div>
      <p>Generando diagrama unifilar...</p>
    </div>
  } @else {
    <div class="svg-container">
      <svg 
        class="unifilar-svg" 
        [attr.width]="svgWidth()" 
        [attr.height]="svgHeight()"
        viewBox="0 0 {{ svgWidth() }} {{ svgHeight() }}"
        style="transform: scale({{ zoom() }});">
        
        <!-- Fondo y cuadrícula -->
        <defs>
          <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#f0f0f0" stroke-width="1"/>
          </pattern>
        </defs>
        
        <rect width="100%" height="100%" fill="url(#grid)"/>
        
        <!-- Líneas de conexión -->
        @for (element of svgElements(); track element.id) {
          @if (element.type === 'main') {
            <!-- Línea desde alimentador principal -->
            <line 
              [attr.x1]="element.x" 
              [attr.y1]="element.y + 20" 
              [attr.x2]="element.x" 
              [attr.y2]="element.y + 80" 
              stroke="#2E86AB" 
              stroke-width="3"/>
          } @else if (element.type === 'protection') {
            <!-- Líneas a cargas -->
            @for (load of svgElements(); track load.id) {
              @if (load.type === 'load' && load.x === element.x) {
                <line 
                  [attr.x1]="element.x" 
                  [attr.y1]="element.y + 15" 
                  [attr.x2]="load.x" 
                  [attr.y2]="load.y - 5" 
                  stroke="#666" 
                  stroke-width="2"/>
              }
            }
          }
        }
        
        <!-- Elementos del circuito -->
        @for (element of svgElements(); track element.id) {
          <g [attr.transform]="'translate(' + element.x + ',' + element.y + ')'">
            
            <!-- Símbolos según el tipo -->
            @if (element.type === 'main') {
              <!-- Alimentador principal -->
              <rect x="-30" y="-10" width="60" height="20" fill="#2E86AB" stroke="#000" stroke-width="2"/>
              <text x="0" y="5" text-anchor="middle" fill="white" font-size="10">AL</text>
            } @else if (element.type === 'protection') {
              <!-- Interruptor -->
              <rect x="-20" y="-8" width="40" height="16" fill="#A23B72" stroke="#000" stroke-width="2"/>
              <text x="0" y="4" text-anchor="middle" fill="white" font-size="8">CB</text>
            } @else if (element.type === 'load') {
              <!-- Carga -->
              <circle cx="0" cy="0" r="8" fill="#C73E1D" stroke="#000" stroke-width="1"/>
              <text x="0" y="3" text-anchor="middle" fill="white" font-size="6">L</text>
            }
            
            <!-- Etiqueta -->
            <text x="0" y="25" text-anchor="middle" fill="#333" font-size="10" font-weight="bold">
              {{ element.label }}
            </text>
            
            <!-- Rating -->
            @if (element.rating) {
              <text x="0" y="38" text-anchor="middle" fill="#666" font-size="8">
                {{ element.rating }}
              </text>
            }
          </g>
        }
      </svg>
    </div>

    <!-- Leyenda -->
    <div class="legend">
      <h4>Leyenda</h4>
      <div class="legend-items">
        <div class="legend-item">
          <div class="legend-symbol main-symbol"></div>
          <span>Alimentador Principal</span>
        </div>
        <div class="legend-item">
          <div class="legend-symbol protection-symbol"></div>
          <span>Interruptor</span>
        </div>
        <div class="legend-item">
          <div class="legend-symbol load-symbol"></div>
          <span>Carga</span>
        </div>
      </div>
    </div>
  }
</div>

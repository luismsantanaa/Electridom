<div class="validation-container">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">
      <i class="fas fa-shield-alt text-primary me-2"></i>
      Validación de Protecciones
    </h5>
    <div class="d-flex gap-2">
      <button 
        class="btn btn-sm btn-outline-primary"
        (click)="refreshValidation()"
        [disabled]="loading">
        <i class="fas fa-sync-alt me-1"></i>
        Refrescar
      </button>
    </div>
  </div>

  <!-- Mensajes de Error -->
  <div class="mb-3" *ngIf="error">
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="fas fa-exclamation-triangle me-2"></i>
      {{ error }}
      <button type="button" class="btn-close" (click)="clearError()"></button>
    </div>
  </div>

  <!-- Loading -->
  <div class="mb-3" *ngIf="loading">
    <div class="d-flex justify-content-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Validando...</span>
      </div>
      <span class="ms-2">Validando protecciones...</span>
    </div>
  </div>

  <!-- Resumen de Validación -->
  <div class="mb-4" *ngIf="validationResult && !loading">
    <div class="card">
      <div class="card-header">
        <h6 class="card-title mb-0">
          <i class="fas fa-clipboard-check me-2"></i>
          Resumen de Validación
        </h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3">
            <div class="text-center">
              <div class="h4 mb-1">{{ validationResult.totalCircuits }}</div>
              <small class="text-muted">Total Circuitos</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center">
              <div class="h4 mb-1 text-info">{{ validationResult.summary.info }}</div>
              <small class="text-muted">Información</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center">
              <div class="h4 mb-1 text-warning">{{ validationResult.summary.warnings }}</div>
              <small class="text-muted">Advertencias</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center">
              <div class="h4 mb-1 text-danger">{{ validationResult.summary.errors + validationResult.summary.critical }}</div>
              <small class="text-muted">Errores</small>
            </div>
          </div>
        </div>
        
        <!-- Estado General -->
        <div class="mt-3 text-center">
          <div *ngIf="validationResult.isValid" class="alert alert-success mb-0">
            <i class="fas fa-check-circle me-2"></i>
            <strong>✅ Todas las protecciones son válidas</strong>
          </div>
          <div *ngIf="!validationResult.isValid" class="alert alert-warning mb-0">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>⚠️ Se encontraron problemas que requieren atención</strong>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista de Issues -->
  <div *ngIf="validationResult && validationResult.issues.length > 0 && !loading">
    <div class="card">
      <div class="card-header">
        <h6 class="card-title mb-0">
          <i class="fas fa-list-alt me-2"></i>
          Problemas Detectados ({{ validationResult.issues.length }})
        </h6>
      </div>
      <div class="card-body p-0">
        <div class="list-group list-group-flush">
          <div 
            *ngFor="let issue of validationResult.issues; trackBy: trackByIssueId"
            class="list-group-item list-group-item-action"
            [class.expanded]="isIssueExpanded(issue.circuitId)">
            
            <!-- Header del Issue -->
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-2">
                  <span 
                    [class]="'badge ' + getSeverityBadgeClass(issue.severity) + ' me-2'">
                    {{ getSeverityText(issue.severity) }}
                  </span>
                  <span 
                    [class]="'badge ' + getCategoryBadgeClass(issue.category) + ' me-2'">
                    {{ getCategoryText(issue.category) }}
                  </span>
                  <small class="text-muted">Código: {{ issue.code }}</small>
                </div>
                
                <h6 class="mb-1">{{ issue.title }}</h6>
                <p class="mb-1 text-muted">{{ issue.description }}</p>
              </div>
              
              <button 
                class="btn btn-sm btn-outline-secondary ms-2"
                (click)="toggleIssue(issue.circuitId)"
                [attr.aria-expanded]="isIssueExpanded(issue.circuitId)">
                <i 
                  [class]="isIssueExpanded(issue.circuitId) ? 'fas fa-chevron-up' : 'fas fa-chevron-down'">
                </i>
              </button>
            </div>

            <!-- Detalles Expandidos -->
            <div 
              *ngIf="isIssueExpanded(issue.circuitId)"
              class="mt-3 pt-3 border-top">
              
              <!-- Recomendación -->
              <div class="mb-3">
                <h6 class="text-primary">
                  <i class="fas fa-lightbulb me-2"></i>
                  Recomendación
                </h6>
                <p class="mb-0">{{ issue.recommendation }}</p>
              </div>

              <!-- Referencia Normativa -->
              <div class="mb-3" *ngIf="issue.normReference">
                <h6 class="text-info">
                  <i class="fas fa-book me-2"></i>
                  Referencia Normativa
                </h6>
                <code class="bg-light px-2 py-1 rounded">{{ issue.normReference }}</code>
              </div>

              <!-- Valores Actuales vs Esperados -->
              <div class="row" *ngIf="issue.currentValue || issue.expectedValue">
                <div class="col-md-6" *ngIf="issue.currentValue">
                  <h6 class="text-warning">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Valor Actual
                  </h6>
                  <code class="bg-warning bg-opacity-10 px-2 py-1 rounded">
                    {{ issue.currentValue }}
                  </code>
                </div>
                <div class="col-md-6" *ngIf="issue.expectedValue">
                  <h6 class="text-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Valor Esperado
                  </h6>
                  <code class="bg-success bg-opacity-10 px-2 py-1 rounded">
                    {{ issue.expectedValue }}
                  </code>
                </div>
              </div>

              <!-- Acciones -->
              <div class="mt-3">
                <button 
                  class="btn btn-sm btn-primary me-2"
                  (click)="refreshValidation()">
                  <i class="fas fa-sync-alt me-1"></i>
                  Revalidar
                </button>
                <button 
                  class="btn btn-sm btn-outline-secondary">
                  <i class="fas fa-eye me-1"></i>
                  Ver Circuito
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Sin Issues -->
  <div *ngIf="validationResult && validationResult.issues.length === 0 && !loading">
    <div class="card">
      <div class="card-body text-center py-5">
        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
        <h5 class="text-success">¡Excelente!</h5>
        <p class="text-muted mb-0">
          No se encontraron problemas en las protecciones del proyecto.
          Todas las protecciones cumplen con las normativas aplicables.
        </p>
      </div>
    </div>
  </div>

  <!-- Sin Proyecto Seleccionado -->
  <div *ngIf="!projectId && !loading">
    <div class="card">
      <div class="card-body text-center py-5">
        <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
        <h5 class="text-muted">Seleccione un Proyecto</h5>
        <p class="text-muted mb-0">
          Para validar las protecciones, primero debe seleccionar un proyecto.
        </p>
      </div>
    </div>
  </div>
</div>
